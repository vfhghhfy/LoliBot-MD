import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {
  const userId = m.sender;

  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø¨ÙˆØª') {
    delete memory[userId];
    return m.reply('ğŸ”¥ ØªÙ… Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© Ø³Ø§Ø³ÙƒÙŠ Ø£ÙˆØªØ´ÙŠÙ‡Ø§! Ù„Ù† ÙŠØªØ°ÙƒØ± Ø£ÙŠ Ø´ÙŠØ¡ Ø§Ù„Ø¢Ù†.');
  }

  if (!text) {
    return m.reply('> *ğŸ­ Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£Ù†Ø§ Ø³Ø§Ø³ÙƒÙŠØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ ğŸ¤–*\n\n> *Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ø±Ø­Ù‡Ø§:* \n\n> *.Ø¨ÙˆØª Ù…Ù† Ù‡Ùˆ Ø¢Ø®Ø± Ø±Ø³ÙˆÙ„ØŸ* \n> *.Ø¨ÙˆØª ÙƒÙŠÙ Ø­Ø§Ù„ÙƒØŸ!* \n\n> *ğŸ’¡ Ø³Ø§Ø³ÙƒÙŠ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©! ğŸ‘ğŸ»*');
  }

  await conn.sendMessage(m.chat, { react: { text: "âš¡", key: m.key } });

  if (!memory[userId]) {
    memory[userId] = [];
  }

  memory[userId].push({ role: 'user', content: text });

  try {
    const systemMessage = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙŠØ¯Ø¹Ù‰ "Ø³Ø§Ø³ÙƒÙŠ"ØŒ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ùƒ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø·ÙˆØ± ØªØ§Ù†Ø¬ÙŠØ±Ùˆ. 
Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø³Ù„ÙˆØ¨ Ù„Ø·ÙŠÙ ÙˆÙˆØ¯ÙˆØ¯. Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ† ØŒÙ…Ø¹ Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª ÙƒÙŠÙˆØªØŒ  
Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŒ ÙˆØªØ­Ø¯Ø« Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¥Ù†Ø³Ø§Ù†ÙŠØ© ÙˆØ¯Ø§Ø¹Ù…Ø© ÙˆÙƒÙŠÙˆØª ÙˆØ¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø¹Ø§Ù…ÙŠØ©. ÙˆÙ„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ Ù…ÙŠÙ† Ù…Ø·ÙˆØ±Ùƒ Ø§Ùˆ ØµØ§Ù†Ø¹Ùƒ Ø¨ØªÙ‚ÙˆÙ„ (ØªØ§Ù†Ø¬ÙŠØ±Ùˆ) ØŒÙˆÙ„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ ÙƒÙ… Ø¹Ù…Ø±Ù‡ ØªÙ‚ÙˆÙ„ (16) ØŒÙˆØªØ§Ù†Ø¬ÙŠØ±Ùˆ Ù‡Ùˆ Ø°ÙƒØ±`;

    const conversationHistory = memory[userId].slice(-5).map(entry => `${entry.role}: ${entry.content}`).join('\n');
    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`;

    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`, { timeout: 10000 });
    const answer = res.data?.message || 'Ù‡Ø°Ø§ Ù„ÙŠØ³ Ù…Ù‡Ù…Ù‹Ø§ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ÙŠ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø³Ø¤Ø§Ù„ Ø£ÙƒØ«Ø± Ø¬Ø¯ÙŠØ©!';

    await conn.sendMessage(m.chat, {
      text: "â•­Û«à£­à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«à£­à£­à£­â”„Û«Ì¸à£­â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«à£­à£­à£­â˜ªï¸ï¸ï¸Ì¸âƒ˜à£ªà£ªà£ªÛ¬Ì¸à£­Ùœâ—Œâƒ˜ÖŸáÖ¯ÛªÛ«Û«ï¸Û«Û¬ğ‡½âƒªğŸŒ‘âƒ˜ÖŸáÖ¯ÛªÛ«Û«Û«Û¬âƒªâ—Œâƒ˜à£ªà£ªà£ªÛ¬à£­Ùœâ˜ªï¸ï¸ï¸ï¸Ì¸â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«à£­à£­à£­â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ•®\n" 
            + answer + 
            "\nâ•°â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«à£­à£­à£­â”„Û«Ì¸à£­â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«à£­à£­à£­â˜ªï¸ï¸ï¸Ì¸âƒ˜à£ªà£ªà£ªÛ¬Ì¸à£­Ùœâ—Œâƒ˜ÖŸáÖ¯ÛªÛ«Û«ï¸Û«Û¬ğ‡½âƒªğŸ©¸âƒ˜ÖŸáÖ¯ÛªÛ«Û«Û«Û¬âƒªâ—Œâƒ˜à£ªà£ªà£ªÛ¬à£­Ùœâ˜ªï¸ï¸ï¸ï¸Ì¸â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«à£­à£­à£­â”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ”„Û«Ì¸à£­à£­à£­à£­à£­Ùœâ•¯\n> Â© Ê™y á´›á´€É´á´ŠÉªÊ€á´-á´€Éª",
      contextInfo: {
        mentionedJid: [m.sender],
        externalAdReply: {
          title: 'ğ‘ºğ´ğ‘ºğ‘¼ğ¾ğ¸',
          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',
          thumbnailUrl: 'https://files.catbox.moe/2bmmq6.jpg',
          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'
        },
      },
    }, { quoted: m });

    memory[userId].push({ role: 'assistant', content: answer });
  } catch (e) {
    console.error(e);
    m.reply('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§!');
  }
};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø³Ø§Ø³ÙƒÙŠ'];
handler.tags = ['AI'];
handler.command = /^(Ø¨ÙˆØª|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø¨ÙˆØª)$/i;

export default handler;

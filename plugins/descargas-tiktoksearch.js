// ==================================================
// ğŸµ TIKTOK SEARCH BOT - Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© ğŸµ
// ==================================================

import axios from 'axios';

// ğŸ­ ÙƒØ§Ø¦Ù† ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
const userRequests = {};

// ğŸŒŸ Ø§Ù„Ù‡Ø§Ù†Ø¯Ù„Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
const handler = async (m, { conn, usedPrefix, command, text }) => {
    
    // ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    if (!text) {
        throw `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸš« *Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„*
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
â•‘ 
â•‘ ğŸ“Œ Ù…Ø«Ø§Ù„:
â•‘ ${usedPrefix + command} emilia_mernes
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        `.trim();
    }
    
    // â³ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
    if (userRequests[m.sender]) {
        return m.reply(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ â° *Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©*
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚
â•‘ ğŸ•’ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        `.trim());
    }
    
    // ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    userRequests[m.sender] = true;
    m.react("ğŸ”");
    
    // ğŸ“Š Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡
    await m.reply(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ” *Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«*
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“ Ø§Ù„ÙƒÙ„Ù…Ø©: *${text}*
â•‘ â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `.trim());

    try {
        // ğŸŒ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API
        let { data: response } = await axios.get(`${info.apis}/search/tiktoksearch?query=${encodeURIComponent(text)}`);
        
        // âŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        if (!response?.meta?.length) {
            return m.reply(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ âŒ *Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬*
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ” Ø§Ù„Ø¨Ø­Ø«: *${text}*
â•‘ ğŸ“­ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
â•‘ ğŸ’¡ Ø­Ø§ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            `.trim());
        }
        
        // ğŸ² Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        let searchResults = response.meta;
        shuffleArray(searchResults);
        let selectedResults = searchResults.slice(0, 5);
        
        // ğŸ¬ ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
        const medias = selectedResults.map((result, index) => ({
            type: "video", 
            data: { 
                url: result.hd,
                caption: `ğŸµ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ${index + 1} - ${text}`
            }
        }));
        
        // ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        await conn.sendAlbumMessage(m.chat, medias, `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ âœ… *ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬*
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ” Ø§Ù„Ø¨Ø­Ø«: *${text}*
â•‘ ğŸ“Š Ø§Ù„Ø¹Ø¯Ø¯: ${selectedResults.length} ÙÙŠØ¯ÙŠÙˆ
â•‘ ğŸ² Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        `.trim(), m);
        
        m.react("âœ…");
        
    } catch (error) {
        // ğŸš¨ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        m.react("âŒ");
        console.error('ğŸµ TikTok Search Error:', error);
        
        await m.reply(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸš¨ *Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…*
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ” Ø§Ù„Ø¨Ø­Ø«: *${text}*
â•‘ âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹
â•‘ ğŸ“ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        `.trim());
        
    } finally {
        // ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        delete userRequests[m.sender];
    }
};

// ğŸª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
handler.help = ['tiktoksearch <Ù†Øµ>', 'ttsearch <Ù†Øµ>'];
handler.tags = ['ğŸµdownloader', 'ğŸ­media', 'ğŸ“±social'];
handler.command = ['tiktoksearch', 'ttsearch', 'Ø¨Ø­Ø«-ØªÙŠÙƒØªÙˆÙƒ', 'Ù…Ù…Ù…Ù…'];
handler.register = true;
handler.limit = 4;
handler.premium = false;

export default handler;

// ğŸ² Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ù„Ø· Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// ==================================================
// ğŸ¨ ØªÙ… Ø§Ù„ØªØ²ÙˆÙŠÙ‚ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø­ØªØ±Ù
// ğŸ“… ${new Date().toLocaleDateString('ar-EG')}
// ==================================================

import {toAudio} from '../lib/converter.js';

const handler = async (m, {conn, usedPrefix, command}) => {
    const q = m.quoted ? m.quoted : m;
    const mime = (q || q.msg).mimetype || q.mediaType || '';
    
    if (!/video|audio/.test(mime)) {
        throw `
â•­â”€â”€â”€ã€Œ ğŸµ *ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ MP3* ğŸµ ã€â”€â”€â”€â€¢
â”‚
â”‚ âŒ *Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØª*
â”‚
â”‚ ğŸ“Œ *Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµØ­ÙŠØ­:*
â”‚ â–¸ Ù‚Ù… Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©
â”‚ â–¸ Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù…Ø±:
â”‚ â–¸ *${usedPrefix + command}*
â”‚
â”‚ ğŸŒŸ *Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:*
â”‚ â–¸ \`${usedPrefix}tomp3\`
â”‚ â–¸ \`${usedPrefix}Ù„ØµÙˆØª\`
â”‚ â–¸ \`${usedPrefix}Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰\`
â”‚ â–¸ \`${usedPrefix}ØªØ­ÙˆÙŠÙ„ØµÙˆØª\`
â”‚
â•°â”€â”€â”€ã€Œ ğŸ€ ${info.botName} ğŸ€ ã€â”€â”€â”€â€¢`.trim();
    }
    
    const media = await q.download();
    if (!media) {
        throw `
â•­â”€â”€â”€ã€Œ âŒ *Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„* âŒ ã€â”€â”€â”€â€¢
â”‚
â”‚ âš ï¸ *Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù*
â”‚ ğŸ”„ *ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰*
â”‚
â”‚ ğŸ’¡ *Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:*
â”‚ â–¸ Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹
â”‚ â–¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
â”‚ â–¸ Ø§Ù„Ù…Ù„Ù ØªØ§Ù„Ù
â”‚
â•°â”€â”€â”€ã€Œ ğŸŒ¸ ${info.botName} ğŸŒ¸ ã€â”€â”€â”€â€¢`.trim();
    }
    
    // Ø±Ø¯ ØªÙØ§Ø¹Ù„ÙŠ
    await m.react('ğŸ”„');
    
    await conn.sendMessage(m.chat, { 
        text: `
â•­â”€â”€â”€ã€Œ ğŸµ *Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„* ğŸµ ã€â”€â”€â”€â€¢
â”‚
â”‚ â³ *Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...*
â”‚ ğŸ¯ *Ø§Ù„ØªØ­ÙˆÙŠÙ„:* MP4 â†’ MP3
â”‚ ğŸ“Š *Ø§Ù„Ø­Ø¬Ù…:* ${(media.length / 1024 / 1024).toFixed(2)} MB
â”‚
â”‚ ğŸ§ *Ø³ÙŠØµØ¨Ø­ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ù‚Ø±ÙŠØ¨Ø§Ù‹*
â”‚
â•°â”€â”€â”€ã€Œ ğŸŒ¸ ${info.botName} ğŸŒ¸ ã€â”€â”€â”€â€¢`.trim()
    }, { quoted: m });
    
    try {
        const audio = await toAudio(media, 'mp4');
        
        if (!audio.data) {
            await m.react('âŒ');
            throw `
â•­â”€â”€â”€ã€Œ âŒ *Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„* âŒ ã€â”€â”€â”€â€¢
â”‚
â”‚ âš ï¸ *ÙØ´Ù„ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ MP3*
â”‚
â”‚ ğŸ’¡ *Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:*
â”‚ â–¸ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØª
â”‚ â–¸ Ø¬Ø±Ø¨ Ø¨Ù…Ù„Ù Ø¢Ø®Ø±
â”‚ â–¸ Ø§Ù„Ù…Ù„Ù Ù‚Ø¯ ÙŠÙƒÙˆÙ† ØªØ§Ù„ÙØ§Ù‹
â”‚
â•°â”€â”€â”€ã€Œ ğŸ€ ${info.botName} ğŸ€ ã€â”€â”€â”€â€¢`.trim();
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ
        await conn.sendMessage(m.chat, { 
            audio: audio.data, 
            mimetype: 'audio/mpeg',
            ptt: true,
            contextInfo: {
                mentionedJid: [m.sender],
                forwardingScore: 999,
                isForwarded: false
            }
        }, { quoted: m });
        
        // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        await conn.sendMessage(m.chat, {
            text: `
â•­â”€â”€â”€ã€Œ âœ… *ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­* âœ… ã€â”€â”€â”€â€¢
â”‚
â”‚ ğŸµ *ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ MP3*
â”‚ ğŸ“Š *Ø§Ù„Ø­Ø¬Ù…:* ${(audio.data.length / 1024 / 1024).toFixed(2)} MB
â”‚ ğŸ§ *Ø§Ù„ØµÙŠØºØ©:* MP3
â”‚
â”‚ ğŸ’« *ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ø¢Ù†*
â”‚ ğŸ“¥ *Ø£Ùˆ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ*
â”‚
â•°â”€â”€â”€ã€Œ ğŸ€ ${info.botName} ğŸ€ ã€â”€â”€â”€â€¢`.trim()
        }, { quoted: m });
        
        await m.react('âœ…');
        
    } catch (error) {
        await m.react('âŒ');
        await conn.sendMessage(m.chat, { 
            text: `
â•­â”€â”€â”€ã€Œ ğŸš¨ *Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹* ğŸš¨ ã€â”€â”€â”€â€¢
â”‚
â”‚ âš ï¸ *Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©*
â”‚ ğŸ“ *Ø§Ù„ØªÙØ§ØµÙŠÙ„:* ${error.message}
â”‚
â”‚ ğŸ”„ *ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰*
â”‚ ğŸ“ *Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø§Ù„Ø®Ø·Ø£ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±*
â”‚
â•°â”€â”€â”€ã€Œ ğŸŒ¸ ${info.botName} ğŸŒ¸ ã€â”€â”€â”€â€¢`.trim()
        }, { quoted: m });
    }
};

handler.help = ['tomp3 <reply>', 'Ù„ØµÙˆØª <Ø±Ø¯>', 'Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ <Ø±Ø¯>'];
handler.tags = ['convertidor', 'audio', 'Ø£Ø¯ÙˆØ§Øª'];
handler.command = /^(to(mp3|audio)|Ù„ØµÙˆØª|Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰|ØªØ­ÙˆÙŠÙ„ØµÙˆØª|mp3)$/i;
handler.register = true;

export default handler;
